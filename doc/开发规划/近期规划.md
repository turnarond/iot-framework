您当前的边缘 BAS 系统已经具备了**核心业务能力闭环**（采集 → 报警 → 联动 → 控制），且架构清晰、模块解耦。下一步应聚焦于 **“可用性”、“可观测性”、“可验证性”和“边缘自治增强”**。

结合您列出的 4 项（Web 配置、存储、仿真、其他），以下是**优先级排序 + 具体实施建议**，按工程落地顺序排列：

---

## ✅ 第一阶段：补齐边缘自治能力（高优先级）

### 🔹 1. **历史数据存储（必须做）**
> 您已设计 `t_history_data` 表，但尚未实现写入/查询逻辑。

#### 实施建议：
- **由 `nodeserver` 负责写入**：
  - 对 `enable_history=1` 的点位，按 `poll_rate` 或变化率（死区）写入；
  - 使用 **批量插入 + WAL 模式** 提升 SQLite 写入性能（每秒 1k~5k 点可行）；
  - 支持自动清理（如保留最近 30 天）。
- **提供本地 API 查询**（供 Web 使用）：
  ```http
  GET /api/v1/history?point_id=123&start=1700000000000&end=1700086400000
  ← [{"ts":1700000001000, "value":23.5}, ...]
  ```

> 💡 **注意**：若点位含 `string` 类型，需额外建 `t_history_string` 表，或统一用 `TEXT` 存值（牺牲类型但简化架构）。

---

### 🔹 2. **Web Server（边缘配置门户）**
> 让现场工程师无需 SSH 即可配置点位、报警、联动。

#### 功能范围（MVP）：
| 模块 | 功能 |
|------|------|
| **设备/点位管理** | 查看/编辑 `t_devices`, `t_points` |
| **报警规则配置** | 增删改 `t_alarm_rules` |
| **联动规则配置** | 配置触发器 → 动作（复用 `t_linkage_*` 表） |
| **定时任务** | 配置 `t_schedules`（cron 表达式） |
| **实时监控** | 显示当前点位值、报警状态（WebSocket 推送） |
| **历史趋势图** | 基于 `t_history_data` 绘图 |

#### 技术选型建议：
- **语言**：Go（轻量、单二进制、ARM 友好）或 C++（嵌入式传统）；
- **前端**：Vue3 + ECharts（打包成静态资源嵌入 binary）；
- **通信**：RESTful API + WebSocket（实时刷新）；
- **安全**：
  - 本地 HTTPS（自签名证书）；
  - 用户认证（简单密码 or 与 `edge-core` 共享 token）。

> 📌 **部署**：作为独立进程 `web-server`，监听 `https://<edge-ip>:8443`

---

## ✅ 第二阶段：提升可测试性与鲁棒性

### 🔹 3. **仿真数据测试（开发/现场必备）**
> 解决“无真实 PLC 时无法调试”的痛点。

#### 实现方案：
- 在 `nodeserver` 中增加 **仿真驱动（simulator driver）**：
  ```sql
  INSERT INTO t_drivers (name, ...) VALUES ('sim-sine', '正弦波仿真');
  INSERT INTO t_devices (name, driver_id, connparam) VALUES ('SimDev', <id>, '{"period_ms":5000}');
  INSERT INTO t_points (name, device_id, address, datatype) VALUES 
    ('temp_sim', <dev_id>, 'sine:amplitude=10,offset=20', 3); -- float
  ```
- 支持多种模式：
  - 正弦波、阶跃、随机噪声、固定值；
  - 可通过 Web 界面启停仿真设备。

> ✅ **优势**：不依赖外部硬件，现场快速验证报警/联动逻辑。

---

### 🔹 4. **点位计算变量（Computed Variable）支持**
> 您已预留 `point_type=2`（computed_variable），但未实现。

#### 场景示例：
- `total_power = phase_a + phase_b + phase_c`
- `efficiency = output / input * 100`

#### 实现建议：
- 在 `nodeserver` 中增加 **表达式引擎**（轻量级）：
  - 支持基础算术：`+ - * / ()`
  - 支持内置函数：`sin(), avg(), max()`
  - 引用其他点位：`tag("pump_status") ? 1 : 0`
- 计算频率：按 `poll_rate` 定期执行；
- 结果写入 `t_history_data`（若 `enable_history=1`）。

> 📌 **注意**：避免复杂脚本（如 Python），防止安全风险；可用 [muParser](https://beltoforion.de/en/muparser/) 或自研简易解析器。

---

## ✅ 第三阶段：增强可观测性与运维能力

### 🔹 5. **系统健康监控（常被遗漏！）**
> 边缘节点需自报告运行状态。

#### 需监控项：
| 指标 | 来源 | 存储位置 |
|------|------|--------|
| CPU / 内存使用率 | OS API | `system_event_log` |
| 磁盘剩余空间 | OS API | `system_event_log` |
| 服务进程存活 | systemd / 自检 | `system_event_log` |
| 数据库大小 | `PRAGMA page_count` | `system_event_log` |
| 点位采集延迟 | `nodeserver` 自测 | `t_points` 新字段？ |

> 💡 可复用现有 `system_event_log` 表（来自 `edge-core` 的管理 DB），通过 IPC 上报。

---

### 🔹 6. **日志聚合与导出**
> 现场故障时需快速导出日志。

#### 功能：
- Web 界面提供 **日志下载**（zip 包含所有服务日志）；
- 支持按时间/级别过滤；
- 可选：自动上传到云端（通过 `edge-core` 的 log service）。

---

## ✅ 第四阶段：未来扩展（低优先级，但值得规划）

| 功能 | 说明 |
|------|------|
| **远程命令执行** | 通过云平台下发“重启 nodeserver”等指令（复用 `dict_service_type.command`） |
| **OTA 升级** | `app-manager` 支持从云端拉取新版本业务服务 |
| **多协议北向接口** | 除 MQTT 外，支持 HTTP API / CoAP 上报数据 |
| **权限分级** | Web 界面区分“操作员”（只能确认报警）和“工程师”（可改配置） |

---

## 📌 总结：下一步行动清单（按优先级）

| 优先级 | 任务 | 负责服务 | 输出 |
|--------|------|--------|------|
| 🔴 **P0** | 实现历史数据写入/查询 | `nodeserver` + `web-server` | `t_history_data` 可用 |
| 🔴 **P0** | 开发 Web 配置门户（MVP） | 新增 `web-server` | 可配置点位/报警/联动 |
| 🟠 **P1** | 添加仿真驱动 | `nodeserver` | 无硬件可测试 |
| 🟠 **P1** | 实现计算变量（表达式） | `nodeserver` | 支持 `point_type=2` |
| 🟢 **P2** | 系统健康监控上报 | `edge-core` + 各服务 | `system_event_log` 含资源指标 |
| 🟢 **P2** | 日志导出功能 | `web-server` | 可下载诊断包 |

> ✅ **建议启动顺序**：  
> **历史存储 → Web Server → 仿真 → 计算变量**

---

## 💡 额外提醒：避免常见陷阱

1. **不要让 Web Server 直连业务数据库**  
   → 应通过 `nodeserver` 提供的本地 API 读写（保持服务边界）；
2. **历史数据不要无限增长**  
   → 必须实现自动清理策略（如每天凌晨删 31 天前数据）；
3. **Web 认证不要硬编码密码**  
   → 密码应哈希存储在管理 DB 的新表 `web_users` 中；
4. **仿真数据不要影响真实控制**  
   → 仿真点位应禁止 `enable_control=1`（加 CHECK 约束）。

---

如需，我可立即为您提供：
- `web-server` 的 Go 项目模板（含 REST API + Vue 前端嵌入）
- `nodeserver` 的历史数据写入伪代码（带批量提交）
- 仿真驱动的 JSON 配置规范
- 计算变量表达式语法设计

请告诉我您想先推进哪一项！