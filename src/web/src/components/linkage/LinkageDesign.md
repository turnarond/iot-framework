# 联动规则设计方案

## 一、整体架构

联动规则系统由三个核心部分组成：
1. **触发器**：负责监听和触发事件
2. **执行器**：负责执行具体的动作
3. **联动规则**：负责将触发器和执行器绑定起来，定义触发条件和执行逻辑

## 二、触发器设计

### 1. 触发器类型

触发器类型从后端获取，包括：

| 类型 | 描述 | 后端对应表 |
|------|------|------------|
| 报警产生 | 当报警规则触发时产生的事件 | t_event_type (id=1) |
| 报警恢复 | 当报警恢复正常时产生的事件 | t_event_type (id=2) |
| 表达式 | 当表达式计算结果为真时产生的事件 | t_event_type (id=3) |
| 自定义 | 由用户算法插件产生的自定义事件 | t_event_type (id=4) |

### 2. 触发器实例

触发器实例是具体的事件来源，对应后端的 `t_linkage_trigger` 表。每个触发器实例都属于一种触发器类型，并包含相应的配置信息。

## 三、执行器设计

### 1. 执行器类型

执行器类型从后端获取，包括：

| 类型 | 描述 | 后端对应表 |
|------|------|------------|
| 单变量控制 | 控制单个变量的执行器 | t_action_type (id=1) |
| 多变量控制 | 控制多个变量的执行器 | t_action_type (id=2, 3) |

### 2. 执行器实例

执行器实例是具体的动作执行者，对应后端的 `t_linkage_action` 表。每个执行器实例都属于一种执行器类型，并包含相应的参数配置。

## 四、联动规则设计

### 1. 联动规则结构

联动规则对应后端的 `t_linkage_rule` 表，用于将触发器和执行器绑定起来。每个联动规则包含：

- 基本信息：名称、描述、启用状态等
- 逻辑类型：AND（所有条件同时满足）
- 触发器列表：关联的触发器实例
- 执行器列表：关联的执行器实例

### 2. 联动规则流程

1. 当触发器实例触发时，系统会检查关联的联动规则
2. 如果联动规则的所有触发器条件都满足（根据逻辑类型），则执行关联的执行器实例
3. 系统会记录联动执行的日志

## 五、前端实现

### 1. 组件结构

```
LinkageView.vue          // 联动规则主视图
├── LinkageList.vue      // 联动规则列表组件
└── LinkageFormWizard.vue // 联动规则配置向导
    ├── TriggerSelector.vue // 触发器选择组件
    └── ActionSequence.vue  // 执行器序列配置组件
```

### 2. 核心功能

- **触发器管理**：从后端获取触发器类型和实例，支持选择和配置
- **执行器管理**：从后端获取执行器类型和实例，支持选择和配置
- **联动规则管理**：支持创建、编辑、删除联动规则
- **联动规则测试**：支持测试联动规则的触发条件和执行效果

### 3. 数据流

1. 前端从后端获取触发器类型和实例
2. 前端从后端获取执行器类型和实例
3. 前端创建或编辑联动规则，将触发器和执行器绑定起来
4. 前端将联动规则保存到后端
5. 当用户点击编辑时，前端从后端获取完整的联动规则信息，包括触发器和执行器详情

## 六、后端实现

### 1. API接口

| API路径 | 方法 | 功能描述 |
|---------|------|----------|
| /api/event-types | GET | 获取所有事件类型（触发器类型） |
| /api/trigger-sources | GET | 获取所有触发器实例 |
| /api/action-types | GET | 获取所有动作类型（执行器类型） |
| /api/action-instances | GET | 获取所有执行器实例 |
| /api/linkage-rules | GET | 获取所有联动规则 |
| /api/linkage-rules/full | GET | 获取完整的联动规则信息，包含触发器和执行器详情 |
| /api/linkage-rules | POST | 创建新的联动规则 |
| /api/linkage-rules/full | POST | 创建新的联动规则，同时关联触发器和执行器 |
| /api/linkage-rules | PUT | 更新联动规则 |
| /api/linkage-rules | DELETE | 删除联动规则 |

### 2. 数据模型

- **触发器类型**：对应 `t_event_type` 表
- **触发器实例**：对应 `t_linkage_trigger` 表
- **执行器类型**：对应 `t_action_type` 表
- **执行器实例**：对应 `t_linkage_action` 表
- **联动规则**：对应 `t_linkage_rule` 表
- **规则-触发器关联**：对应 `t_linkage_rule_trigger` 表
- **规则-执行器关联**：对应 `t_linkage_rule_action` 表

## 七、实现计划

1. **后端实现**：
   - 确保现有的API接口符合设计要求
   - 实现触发器类型和执行器类型的获取接口
   - 实现联动规则的完整CRUD操作

2. **前端实现**：
   - 实现触发器选择组件，支持从后端获取触发器类型和实例
   - 实现执行器序列配置组件，支持从后端获取执行器类型和实例
   - 实现联动规则配置向导，支持创建、编辑和删除联动规则
   - 实现联动规则列表组件，支持查看和管理联动规则

3. **测试验证**：
   - 测试触发器的触发功能
   - 测试执行器的执行功能
   - 测试联动规则的完整流程
   - 测试编辑功能，确保能正确读取和保存联动规则配置

## 八、技术要点

1. **前后端分离**：前端使用Vue 3 + Element Plus，后端使用C++ + oatpp
2. **数据传输**：使用JSON格式传输数据，前端通过axios调用后端API
3. **错误处理**：完善的错误处理机制，确保系统稳定运行
4. **用户体验**：直观的用户界面，支持拖拽、预览等交互功能
5. **性能优化**：合理的缓存策略，减少不必要的API调用

## 九、总结

本设计方案基于现有的后端架构，通过优化前端实现，提供了一个更加清晰、易用的联动规则配置系统。用户可以通过简单的操作，创建和管理复杂的联动规则，实现系统的自动化控制。